---
import Layout from '../../layouts/Layout.astro';
import Navigation from '../../components/Navigation.astro';
import { t } from '../../i18n/translations';
import Footer from '../../components/Footer.astro';
import '../../styles/global.css';

const lang = 'fr';
const base = import.meta.env.BASE_URL;
---

<Layout title="R√©f√©rences | Research Library">
  <Navigation lang={lang} currentPath="/fr/references" />

  <main class="min-h-screen bg-[#FFF9ED]">
    <!-- Hero Section -->
    <section class="relative py-24 px-6 overflow-hidden">
      <!-- Background Pattern -->
      <div class="absolute inset-0 opacity-5 pointer-events-none">
        <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
              <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#003049" stroke-width="1"/>
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#grid)" />
        </svg>
      </div>

      <div class="max-w-7xl mx-auto relative z-10">
        <div class="grid lg:grid-cols-2 gap-12 items-center">
          <div>
            <div class="inline-block px-4 py-2 bg-[#780000]/10 text-[#780000] rounded-lg text-sm font-bold uppercase tracking-widest mb-6">
              {t('references.badge', lang)}
            </div>
            <h1 class="font-figtree text-6xl md:text-7xl font-bold text-[#003049] mb-8 leading-tight tracking-tight">
              {t('references.title', lang)} <br/>
              <span class="text-[#780000]">{t('references.titleHighlight', lang)}</span>
            </h1>
            <p class="font-figtree text-xl text-[#003049]/70 leading-relaxed font-light max-w-xl" set:html={t('references.intro', lang)} />
          </div>
          
          <div class="relative">
            <!-- Decorative Abstract Composition -->
            <div class="relative aspect-square max-w-md mx-auto">
              <div class="absolute inset-0 bg-[#003049]/5 rounded-full opacity-10 blur-3xl transform -translate-y-12"></div>
              <div class="relative bg-[#FFF9ED] border border-[#003049]/10 p-8 rounded-2xl shadow-2xl transform rotate-3 hover:rotate-0 transition-transform duration-500">
                <div class="flex items-center gap-4 mb-6 border-b border-[#003049]/10 pb-4">
                  <div class="w-12 h-12 bg-[#780000] rounded-lg flex items-center justify-center text-[#FFF9ED]">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                  </div>
                  <div>
                    <div class="text-xs font-bold text-[#669bbc] uppercase tracking-wider">{t('references.featuredLabel', lang)}</div>
                    <div class="font-bold text-[#003049]">{t('references.featuredTitle', lang)}</div>
                  </div>
                </div>
                <p class="font-serif italic text-[#003049]/60 text-lg leading-relaxed">
                  {t('references.featuredQuote', lang)}
                </p>
                <div class="mt-6 flex justify-between items-center">
                  <span class="text-sm font-bold text-[#003049]/40">Kahneman & Tversky, 1979</span>
                  <div class="h-1 w-20 bg-[#780000] rounded-lg"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filters & Search Section -->
    <section class="py-8 px-6 sticky top-0 z-40" id="filterSection">
      <div class="absolute inset-0 bg-[#FFF9ED]/80 backdrop-blur-xl border-b border-[#003049]/5 shadow-sm transition-all duration-300"></div>
      
      <div class="max-w-7xl mx-auto relative z-10">
        <div class="flex flex-col lg:flex-row gap-6 items-center justify-between mb-6">
          <!-- Search Bar -->
          <div class="w-full lg:w-96 relative group">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <svg class="h-5 w-5 text-[#003049]/40 group-focus-within:text-[#780000] transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input
              type="text"
              id="searchInput"
              placeholder="Rechercher dans la biblioth√®que..."
              class="w-full pl-12 pr-6 py-3 font-figtree text-base bg-white/50 border border-[#003049]/10 rounded-xl focus:border-[#780000] focus:outline-none focus:ring-4 focus:ring-[#780000]/5 text-[#003049] placeholder:text-[#003049]/40 transition-all shadow-sm hover:shadow-md hover:bg-white/80"
            />
          </div>

          <!-- Active filters display -->
          <div id="activeFilters" class="hidden lg:block font-figtree text-sm text-[#003049]/60 bg-[#003049]/5 px-4 py-2 rounded-lg">
            {t('references.activeFilters', lang)} <span id="filterList" class="font-bold text-[#780000]"></span>
          </div>
        </div>

        <!-- Category Filters -->
        <div class="flex flex-wrap gap-2 justify-center lg:justify-start pb-2">
          <button
            class="filter-btn group relative px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 overflow-hidden active border border-[#003049]/10 hover:border-[#003049]/30 bg-white/50"
            data-category="all"
          >
            <span class="relative z-10 flex items-center gap-2">
              Tout <span class="count bg-[#003049]/10 px-1.5 py-0.5 rounded text-[10px]">69</span>
            </span>
          </button>
          <button class="filter-btn group relative px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 overflow-hidden border border-[#003049]/10 hover:border-[#003049]/30 bg-white/50" data-category="Core Reading">
            <span class="relative z-10 flex items-center gap-2">Lecture Essentielle <span class="count bg-[#003049]/10 px-1.5 py-0.5 rounded text-[10px]">0</span></span>
          </button>
          <button class="filter-btn group relative px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 overflow-hidden border border-[#003049]/10 hover:border-[#003049]/30 bg-white/50" data-category="Trust & Trust Game">
            <span class="relative z-10 flex items-center gap-2">Confiance <span class="count bg-[#003049]/10 px-1.5 py-0.5 rounded text-[10px]">0</span></span>
          </button>
          <button class="filter-btn group relative px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 overflow-hidden border border-[#003049]/10 hover:border-[#003049]/30 bg-white/50" data-category="Risk & Decision Theory">
            <span class="relative z-10 flex items-center gap-2">Risque <span class="count bg-[#003049]/10 px-1.5 py-0.5 rounded text-[10px]">0</span></span>
          </button>
          <button class="filter-btn group relative px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 overflow-hidden border border-[#003049]/10 hover:border-[#003049]/30 bg-white/50" data-category="Trust-Risk Relationship">
            <span class="relative z-10 flex items-center gap-2">Confiance-Risque <span class="count bg-[#003049]/10 px-1.5 py-0.5 rounded text-[10px]">0</span></span>
          </button>
          <button class="filter-btn group relative px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 overflow-hidden border border-[#003049]/10 hover:border-[#003049]/30 bg-white/50" data-category="Social Preferences">
            <span class="relative z-10 flex items-center gap-2">Social <span class="count bg-[#003049]/10 px-1.5 py-0.5 rounded text-[10px]">0</span></span>
          </button>
          <button class="filter-btn group relative px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 overflow-hidden border border-[#003049]/10 hover:border-[#003049]/30 bg-white/50" data-category="Neuroscience">
            <span class="relative z-10 flex items-center gap-2">Neuro <span class="count bg-[#003049]/10 px-1.5 py-0.5 rounded text-[10px]">0</span></span>
          </button>
          <button class="filter-btn group relative px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300 overflow-hidden border border-[#003049]/10 hover:border-[#003049]/30 bg-white/50" data-category="Methods & Computational">
            <span class="relative z-10 flex items-center gap-2">Methods <span class="count bg-[#003049]/10 px-1.5 py-0.5 rounded text-[10px]">0</span></span>
          </button>
        </div>
      </div>
    </section>

    <!-- References Grid -->
    <section class="py-12 px-6 bg-[#003049]">
      <div class="max-w-6xl mx-auto">
        <!-- Loading state -->
        <div id="loading" class="text-center py-12">
          <div class="inline-block w-12 h-12 border-4 border-[#FFF9ED]/20 border-t-[#780000] rounded-full animate-spin"></div>
          <p class="font-figtree text-[#FFF9ED]/70 mt-4">Chargement des r√©f√©rences...</p>
        </div>

        <!-- No results message -->
        <div id="noResults" class="hidden text-center py-12">
          <p class="font-figtree text-xl text-[#FFF9ED]/70">Aucune r√©f√©rence ne correspond √† vos crit√®res.</p>
          <button
            onclick="resetFilters()"
            class="mt-4 font-figtree px-6 py-3 bg-[#780000] text-white rounded-lg hover:bg-[#780000]/90 transition-colors font-semibold"
          >
            Effacer tous les filtres
          </button>
        </div>

        <!-- Results count -->
        <div id="resultsCount" class="hidden mb-6 font-figtree text-[#FFF9ED]/70">
          Affichage de <span id="countNumber" class="font-bold text-[#780000]">0</span> r√©f√©rences
        </div>

        <!-- References container -->
        <div id="referencesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
      </div>
    </section>
  </main>

  <Footer lang={lang} />
</Layout>

<script is:inline define:vars={{ base }}>
  window.__BASE_URL__ = base;
</script>

<style>
  /* Filter button styles */
  .filter-btn {
    background-color: transparent;
    border: 1px solid rgba(0, 48, 73, 0.1);
    color: #003049;
  }

  .filter-btn:hover {
    background-color: rgba(0, 48, 73, 0.05);
    border-color: rgba(0, 48, 73, 0.2);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .filter-btn.active {
    background-color: #003049;
    border-color: #003049;
    color: #FFF9ED;
    box-shadow: 0 4px 6px rgba(0, 48, 73, 0.2);
  }

  .filter-btn.active .count {
    background-color: rgba(255, 255, 255, 0.2);
    color: #FFF9ED;
  }

  /* Core Reading gets special red color when active */
  .filter-btn[data-category="Core Reading"].active {
    background-color: #780000;
    border-color: #780000;
    color: #FFF9ED;
    box-shadow: 0 4px 6px rgba(120, 0, 0, 0.2);
  }

  /* Category tag colors - NO RED ON BLUE! */
  .tag-core {
    background-color: #780000;
    color: #FFF9ED;
  }

  .tag-trust {
    background-color: #003049;
    color: #FFF9ED;
  }

  .tag-risk {
    background-color: #669bbc;
    color: white;
  }

  .tag-relationship {
    background-color: #780000;
    color: #FFF9ED;
  }

  .tag-social {
    background-color: #669bbc;
    color: white;
  }

  .tag-neuro {
    background-color: #003049;
    color: #FFF9ED;
  }

  .tag-methods {
    background-color: #669bbc;
    color: white;
  }

  /* Custom Scrollbar for back of card */
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(255, 249, 237, 0.05);
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(255, 249, 237, 0.2);
    border-radius: 2px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 249, 237, 0.4);
  }
</style>

<script is:inline>
  // Get base URL from inline script
  const BASE_URL = window.__BASE_URL__ || '';

  // Global variables
  let allReferences = [];
  let activeCategories = new Set(['all']);
  let searchQuery = '';

  // Category tag mapping
  const categoryTagClass = {
    'Core Reading': 'tag-core',
    'Trust & Trust Game': 'tag-trust',
    'Risk & Decision Theory': 'tag-risk',
    'Trust-Risk Relationship': 'tag-relationship',
    'Social Preferences': 'tag-social',
    'Neuroscience': 'tag-neuro',
    'Methods & Computational': 'tag-methods'
  };

  // French category names
  const categoryNamesFR = {
    'Core Reading': 'Lecture Essentielle',
    'Trust & Trust Game': 'Confiance & Jeu de Confiance',
    'Risk & Decision Theory': 'Risque & Th√©orie de la D√©cision',
    'Trust-Risk Relationship': 'Relation Confiance-Risque',
    'Social Preferences': 'Pr√©f√©rences Sociales',
    'Neuroscience': 'Neurosciences',
    'Methods & Computational': 'M√©thodes & Informatique'
  };

  // Load references on page load
  async function loadReferences() {
    try {
      console.log('üîç Attempting to load references.json...');
      // Try multiple paths to be robust - load French version
      const paths = [
        'references-fr.json',
        '/references-fr.json',
        BASE_URL + 'references-fr.json',
        '/trust-risk-website/references-fr.json'
      ];
      
      let response;
      let loaded = false;

      for (const path of paths) {
        try {
          console.log(`Trying path: ${path}`);
          response = await fetch(path);
          if (response.ok) {
            loaded = true;
            console.log(`‚úÖ Success loading from: ${path}`);
            break;
          }
        } catch (e) {
          console.log(`Failed path: ${path}`);
        }
      }

      if (!loaded) {
        throw new Error(`Could not load references.json from any path. Last status: ${response ? response.status : 'unknown'}`);
      }

      const data = await response.json();
      console.log('‚úÖ Data loaded successfully, references count:', data.references.length);
      allReferences = data.references;

      updateCategoryCounts();
      displayReferences(allReferences);

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('resultsCount').classList.remove('hidden');
      console.log('‚úÖ References displayed successfully');
    } catch (error) {
      console.error('‚ùå Error loading references:', error);
      console.error('Error details:', error.message);
      document.getElementById('loading').innerHTML =
        '<div class="text-center"><p class="font-figtree text-lg text-[#780000] mb-4">Error loading references.</p><p class="font-figtree text-sm text-[#003049]/70 mb-4">Error: ' + error.message + '</p><p class="font-figtree text-sm text-[#003049]/70">Try: Cmd+Shift+R to hard refresh, or restart npm run dev</p><p class="font-figtree text-xs text-[#003049]/50 mt-4">Check browser console (Cmd+Option+I) for details</p></div>';
    }
  }

  // Update category counts
  function updateCategoryCounts() {
    const counts = {
      'all': allReferences.length,
      'Core Reading': 0,
      'Trust & Trust Game': 0,
      'Risk & Decision Theory': 0,
      'Trust-Risk Relationship': 0,
      'Social Preferences': 0,
      'Neuroscience': 0,
      'Methods & Computational': 0
    };

    allReferences.forEach(ref => {
      ref.categories.forEach(cat => {
        if (counts[cat] !== undefined) {
          counts[cat]++;
        }
      });
    });

    // Update button counts
    document.querySelectorAll('.filter-btn').forEach(btn => {
      const category = btn.dataset.category;
      const countSpan = btn.querySelector('.count');
      if (countSpan && counts[category] !== undefined) {
        countSpan.textContent = counts[category];
      }
    });
  }

  // Filter references with AND logic (intersection)
  function filterReferences() {
    let filtered = allReferences;

    // Apply category filter with AND logic (intersection)
    if (!activeCategories.has('all') && activeCategories.size > 0) {
      filtered = filtered.filter(ref => {
        // Reference must have ALL active categories
        return Array.from(activeCategories).every(activeCat => 
          ref.categories.includes(activeCat)
        );
      });
    }

    // Apply search query
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(ref =>
        ref.authors.toLowerCase().includes(query) ||
        ref.title.toLowerCase().includes(query) ||
        ref.year.toString().includes(query) ||
        ref.relevance.toLowerCase().includes(query) ||
        ref.categories.some(cat => cat.toLowerCase().includes(query))
      );
    }

    displayReferences(filtered);
  }

  // Display references
  function displayReferences(references) {
    const container = document.getElementById('referencesContainer');
    const noResults = document.getElementById('noResults');
    const resultsCount = document.getElementById('resultsCount');
    const countNumber = document.getElementById('countNumber');

    if (references.length === 0) {
      container.innerHTML = '';
      noResults.classList.remove('hidden');
      resultsCount.classList.add('hidden');
      return;
    }

    noResults.classList.add('hidden');
    resultsCount.classList.remove('hidden');
    countNumber.textContent = references.length;

    container.innerHTML = references.map(ref => createReferenceCard(ref)).join('');
  }

  // Create reference card HTML
  function createReferenceCard(ref) {
    const doiLink = ref.doi ? `https://doi.org/${ref.doi}` : '#';

    const categoryTags = ref.categories.map(cat => {
      const tagClass = categoryTagClass[cat] || 'bg-[#003049] text-[#FFF9ED]';
      const isActive = activeCategories.has(cat);
      const catNameFR = categoryNamesFR[cat] || cat; // Use French name or fallback to original
      
      // Use same style as filter buttons
      if (isActive) {
        // Active state - matches active filter button style
        const activeClass = cat === 'Core Reading' ? 'bg-[#780000] border-[#780000]' : 'bg-[#003049] border-[#003049]';
        return `<span class="inline-block px-3 py-1 rounded-md text-xs font-bold transition-all duration-300 ${activeClass} text-[#FFF9ED] shadow-sm">${catNameFR}</span>`;
      } else {
        // Inactive state - matches inactive filter button style  
        return `<span class="inline-block px-3 py-1 rounded-md text-xs font-bold transition-all duration-300 bg-transparent border border-[#003049]/10 text-[#003049]/70 hover:bg-[#003049]/5">${catNameFR}</span>`;
      }
    }).join(' ');

    return `
      <div class="group perspective-[1000px] h-[450px]">
        <div class="relative w-full h-full transition-all duration-700 [transform-style:preserve-3d] group-hover:[transform:rotateY(180deg)] shadow-sm hover:shadow-2xl rounded-2xl">
          
          <!-- Front Face -->
          <div class="absolute inset-0 [backface-visibility:hidden] bg-[#FFF9ED] border border-[#003049]/5 rounded-2xl p-8 flex flex-col justify-between overflow-hidden shadow-sm hover:border-[#003049]/20 transition-colors">
            <!-- Decorative top accent -->
            <div class="absolute top-0 left-0 right-0 h-1 bg-[#780000] opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>

            <div>
              <div class="font-figtree mb-4">
                <div class="flex items-center gap-2 mb-4">
                   <span class="px-2 py-1 bg-[#003049]/5 text-[#003049] text-[10px] font-bold uppercase tracking-widest rounded">${ref.year}</span>
                   ${ref.journal ? `<span class="text-[#003049]/40 text-xs font-serif italic truncate max-w-[180px]">${ref.journal}</span>` : ''}
                </div>
                <p class="text-[#003049] font-bold text-2xl mb-4 leading-tight tracking-tight group-hover:text-[#780000] transition-colors duration-300">
                  ${ref.title}
                </p>
                <div class="flex items-start gap-2 text-[#003049]/70 font-medium text-sm mb-3">
                  <svg class="w-4 h-4 text-[#780000] mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                  <span class="line-clamp-2">${ref.authors}</span>
                </div>
              </div>
            </div>
            
            <div class="mt-4">
              <div class="flex flex-wrap gap-2 mb-6">
                ${categoryTags}
              </div>
              
              <div class="flex items-center justify-between pt-4 border-t border-[#003049]/5">
                <span class="text-[#003049]/40 text-xs font-semibold">Survoler pour retourner</span>
                <div class="flex items-center gap-1 text-[#003049] text-xs font-bold uppercase tracking-widest group-hover:text-[#780000] transition-colors">
                  <span>D√©tails</span>
                  <svg class="w-4 h-4 transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </div>
              </div>
            </div>
          </div>

          <div class="absolute inset-0 [backface-visibility:hidden] [transform:rotateY(180deg)] bg-[#669bbc] text-[#003049] rounded-2xl p-8 flex flex-col h-full shadow-inner border border-[#003049]/10">
            <div class="flex-grow overflow-y-auto custom-scrollbar pr-2">
              <h3 class="font-bold text-lg mb-4 text-[#FFF9ED] flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Pourquoi c'est important
              </h3>
              <p class="font-figtree text-base leading-relaxed text-[#003049]/90 font-medium">
                ${ref.relevance}
              </p>
            </div>
            
            <div class="mt-6 pt-6 border-t border-[#003049]/10 flex-shrink-0">
              ${ref.doi ? `
                <a href="${doiLink}" target="_blank" rel="noopener"
                   class="group/btn flex items-center justify-center gap-2 w-full px-6 py-4 bg-[#780000] text-[#FFF9ED] rounded-xl hover:bg-[#5a0000] transition-all duration-300 font-bold text-sm uppercase tracking-wider shadow-lg hover:shadow-[#780000]/40 hover:-translate-y-0.5">
                  <span>Lire l'Article</span>
                  <svg class="w-4 h-4 transition-transform group-hover/btn:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </a>
              ` : `
                <div class="block w-full text-center px-6 py-4 bg-[#FFF9ED]/10 text-[#003049]/60 rounded-xl text-sm font-medium cursor-not-allowed border border-[#003049]/5">
                  Pas de DOI Disponible
                </div>
              `}
            </div>
          </div>
          
        </div>
      </div>
    `;
  }

  // Handle filter button clicks
  function setupFilterButtons() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.dataset.category;

        if (category === 'all') {
          // Clear all filters and activate "All"
          activeCategories.clear();
          activeCategories.add('all');
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        } else {
          // Remove "All" filter
          activeCategories.delete('all');
          document.querySelector('.filter-btn[data-category="all"]').classList.remove('active');

          // Toggle category
          if (activeCategories.has(category)) {
            activeCategories.delete(category);
            btn.classList.remove('active');
          } else {
            activeCategories.add(category);
            btn.classList.add('active');
          }

          // If no categories selected, reactivate "All"
          if (activeCategories.size === 0) {
            activeCategories.add('all');
            document.querySelector('.filter-btn[data-category="all"]').classList.add('active');
          }
        }

        updateActiveFiltersDisplay();
        filterReferences();
      });
    });
  }

  // Update active filters display
  function updateActiveFiltersDisplay() {
    const activeFiltersDiv = document.getElementById('activeFilters');
    const filterList = document.getElementById('filterList');

    if (activeCategories.has('all') || activeCategories.size === 0) {
      activeFiltersDiv.classList.add('hidden');
    } else {
      activeFiltersDiv.classList.remove('hidden');
      filterList.textContent = Array.from(activeCategories).join(', ');
    }
  }

  // Handle search input
  function setupSearch() {
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      filterReferences();
    });
  }

  // Reset all filters
  window.resetFilters = function() {
    activeCategories.clear();
    activeCategories.add('all');
    searchQuery = '';

    document.getElementById('searchInput').value = '';
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.filter-btn[data-category="all"]').classList.add('active');

    updateActiveFiltersDisplay();
    filterReferences();
  };

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadReferences();
    setupFilterButtons();
    setupSearch();
  });
</script>
